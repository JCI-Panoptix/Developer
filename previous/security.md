--- 
layout: previous 
title: Security and Authorization 
previous-version: true
categories: [General]
--- 

##Security and Authorization

The Panoptix速 API uses the OAuth v2 protocol for authentication and authorization. It is a standard used by many API providers, including the Google速, Facebook速 and Netflix速 platforms. Applications accessing the Panoptix
API must first authenticate on behalf of a company before they can retrieve Panoptix data for that company. In addition, each application is given a unique client id and client secret that is used to identify and authenticate
the application itself.

The first step in the process is to retrieve an access token from the Panoptix Authorization Server. The access token is then passed as an HTTP header, when making calls to the Panoptix API service methods.


The diagram below is a representation of the authentication process for the Panoptix API. This work flow is referred to as the OAuth v2 grant type of Resource Owner Password Credentials.

![Figure One]({{site.baseurl}}/images/previous/Figure1.png?raw=true)

###Transport Security

Industry standard HTTPS/SSL transport security is required for all API requests. Requests made via HTTP are not supported. The SSL certificates used by Panoptix are issued by Entrust and utilize 2048 bit RSA public keys.

### Credentials

#### Application Credentials

When you sign up for the Panoptix API your application is registered and issued a set of credentials called __client id__ and __client secret__. These credentials are used to identify your application. The client id once defined for an application will never change, but the client secret can be regenerated by you using the Panoptix Developer Center.

####Service Account Credentials
The grant type of Resource Owner Password Credentials requires a second set of credentials to identify the company who owns the data you wish to access via the Panoptix API. These credentials represent a non-human user account called a service account, and are controlled by the company making their data available to the Panoptix API. These credentials are called service account id and service account password.
 
####Multi-Company Data Access
An application may need access to Panoptix data for several different companies. This requires a separate set of service account credentials for each company, and for the application to submit these credentials when requesting a separate access token per company.

![Figure Two]({{site.baseurl}}/images/previous/Figure2.png?raw=true)

####Sandbox vs. Production Credentials
The Panoptix API has two main environments, referred to as Sandbox and Production. The Sandbox environment is designed for use with application development and testing and contains a limited set of data made available to all applications. When your application is first registered it will be given application credentials associated with the Sandbox environment. Later when your application is ready for production use it will be given new application credentials associated with the Production environment.
 
###Authentication Details
 
When requesting an access token you will need to provide the following parameters:
 
#####Table One: Input Parameters
Parameter	|Parameter Type	|Description	|Example
------------|---------------|---------------|-------
client_id	|HTTP Basic Authentication	|Your application id	|70e3fa06
client_secret	|HTTP Basic Authentication	|Your application secret	|35ef3abeb4d69e45accf701a9aeb72f2
grant_type	|Query String or Form Field	|The OAuth v2 grant type, currently always password	|password
username	|Query String or Form Field	|Company service account id	|wayne_enterprises.test_application
password	|Query String or Form Field	|Company service account password	|ztcx5khgaerueyrnd1wwayidlgzxfd



The access token request is performed using an HTTP POST with Basic Authentication as shown below. In this example, the input parameters described in Table One are submitted to the Panoptix Authorization Server at: [https://mypanoptix.johnsoncontrols.com/identity/issue/oauth2/token](https://mypanoptix.johnsoncontrols.com/identity/issue/oauth2/token)

{% highlight javascript linenos %}

    POST identity/issue/oauth2/token HTTP/1.1
    Host: mypanoptix.johnsoncontrols.com
    Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
    Content-Type: application/x-www-form-urlencoded
    grant_type=password&amp;
    username=wayne_enterprises.test_application&amp;
    password=ztcx5khgaerueyrnd1wwayidlgzxfd

{% endhighlight %}    

    

The HTTP header "Authorization" indicates the use of Basic Authentication. The client_id and client_secret are concatenated with a colon (:) delimiter and base 64 encoded.


  * For more information on Basic Authentication see: [http://en.wikipedia.org/wiki/Basic_access_authentication](http://en.wikipedia.org/wiki/Basic_access_authentication)
  * For an example of using jQuery to connect to a web service using Basic Authentication see: [http://www.aswinanand.com/2009/01/http-basic-authentication-using-ajax/](http://www.aswinanand.com/2009/01/http-basic-authentication-using-ajax/)


The response returned is in JSON format and consists of the fields described in Table Two.


#####Table Two: Response Fields

**Field**	|**Response**
--------|--------
access_token	|the value of this field is the actual access token value that should be submitted with each request to the PPS API
token_type	|the format used for the access token
expires_in	|the number of seconds before the access token will expire and a new one will need to be requested
refresh_token	|this is currently always null



{% highlight JSON linenos %}

    {
    access_token: "http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fname=wayne_enterprises.test_application&amp;http%3a%2f%2fschemas.microsoft.com%2fws%2f2008%2f06%2fidentity%2fclaims%2fauthenticationmethod=http%3a%2f%2fschemas.microsoft.com%2fws%2f2008%2f06%2fidentity%2fauthenticationmethod%2fpassword&amp;http%3a%2f%2fschemas.microsoft.com%2fws%2f2008%2f06%2fidentity%2fclaims%2fauthenticationinstant=2013-05-13T15%3a57%3a55.678Z&amp;http%3a%2f%2fjci.com%2fclaims%2fappid=70e3fa06&amp;http%3a%2f%2fschemas.microsoft.com%2fws%2f2008%2f06%2fidentity%2fclaims%2frole=ServiceAccount&amp;http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=670104a6-6818-45cc-a427-1644fdcd7b55&amp;http%3a%2f%2fjci.com%2fclaims%2fcompanyguid=ad342ff1-bbcd-4b19-ba4a-f8c61c2a76c0&amp;Issuer=https%3a%2f%2fidentity.johnsoncontrols.com&amp;Audience=urn%3aims%3apanoptix&amp;ExpiresOn=1368464276&amp;HMACSHA256=DFWtjGHbNiMqivESxjVt1bmzNeFvYBSENTSYDjHmyg0%3d"
    token_type: "http://schemas.xmlsoap.org/ws/2009/11/swt-token-profile-1.0"
    expires_in: 3600
    refresh_token: null
    }

{% endhighlight %}       
    

Note: the access token value is not intended to be parsed and utilized by your application. The format could change at any time and the content is designed for use by the Panoptix API only.


### Retrieving the Access Token


#### Sample Code (C#)

The following C# example utilizes the RestSharp library to build the token request and parse the JSON result. Learn more about RestSharp](http://restsharp.org/).

{% highlight csharp linenos %}

    public string GetAccessToken(string serviceAccountId, string serviceAccountPassword)  
	{  
    const string clientId = "879e65d3";  
    const string clientSecret = "35ef3abeb4d69e45accf701a9aeb72f2";  
    IRestClient restClient = new RestClient("https://mypanoptix.johnsoncontrols.com");  
    restClient.Authenticator = new HttpBasicAuthenticator(clientId, clientSecret);  
    IRestRequest request = new RestRequest("identity/issue/oauth2/token?  
        grant_type=password&username={username}&password={password}");            
    request.AddParameter("username", serviceAccountId, ParameterType.UrlSegment);  
    request.AddParameter("password", serviceAccountPassword, ParameterType.UrlSegment);                  
    var response = restClient.Post(request);  
    if (response.StatusCode != HttpStatusCode.OK)  
    {  
        throw new Exception(string.Format("Authentication failed: {0}", response.Content));  
    }  
  
    // Parse access token from response  
    JObject json = JObject.Parse(response.Content);  
    return (string)json["access_token"];  
	}  

{% endhighlight %}     
    
#### Sample Code (Python)

{% highlight python linenos %}

    def GetAccessToken(self):  
    PPSoAuthEndpoint =    
        'https://mypanoptix.johnsoncontrols.com/identity/issue/oauth2/token'      
    opener = urllib2.build_opener(urllib2.HTTPHandler(debuglevel=1))   
    # Build Query string parameters  
    postParams = urllib.urlencode({'username':self.serviceAccountId,  
        'password':self.serviceAccountPwd, 'grant_type': 'password'})  
    url = PPSoAuthEndpoint + "?" + postParams   
    # Build Header (Basic Authentication)   
    auth_hash = self.clientid + ':' + self.client_secret   
    user_info = auth_hash.encode("base64").strip()   
    header = {'Authorization': "Basic " + user_info}   
    try:  
        # Request Access Token - POST  
        req = urllib2.Request(url, postParams, header)   
        httpResponse = opener.open(req).read()             
        # Parse token response   
        jsontoken = json.loads(httpResponse)   
        access_token = jsontoken['access_token']  
        token_type = jsontoken['token_type']   
        expires_in = jsontoken['expires_in']   
        refresh_token = jsontoken['refresh_token']        
    except urllib2.HTTPError, e:   
        httpResponse = json.dumps({   
        "statuscode":e.code,   
        "bodymessage":e.read(),   
        "url":url,   
        });        
    return httpResponse; 

{% endhighlight %}    
    

## Using the Access Token

The access token is passed to a Panoptix API method using a standard HTTP Authorization header as shown below. The header value is prefixed with the text Bearer, followed by a space, followed by the access token.

{% highlight javascript linenos %}

	GET /v1/Configuration/Meters HTTP/1.1   
	Host: api.mypanoptix.johnsoncontrols.com    
	Authorization: Bearer  http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fname=wayne_enterprises.test_application&http%3a%2f%2fschemas.microsoft.com%2fws%2f2008%2f06%2fidentity%2fclaims%2fauthenticationmethod=http%3a%2f%2fschemas.microsoft.com%2fws%2f2008%2f06%2fidentity%2fauthenticationmethod%2fpassword&http%3a%2f%2fschemas.microsoft.com%2fws%2f2008%2f06%2fidentity%2fclaims%2fauthenticationinstant=2013-05-13T15%3a57%3a55.678Z&http%3a%2f%2fjci.com%2fclaims%2fappid=70e3fa06&http%3a%2f%2fschemas.microsoft.com%2fws%2f2008%2f06%2fidentity%2fclaims%2frole=ServiceAccount&http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=670104a6-6818-45cc-a427-1644fdcd7b55&http%3a%2f%2fjci.com%2fclaims%2fcompanyguid=ad342ff1-bbcd-4b19-ba4a-f8c61c2a76c0&Issuer=https%3a%2f%2fidentity.johnsoncontrols.com&Audience=urn%3aims%3apanoptix&ExpiresOn=1368464276&HMACSHA256=DFWtjGHbNiMqivESxjVt1bmzNeFvYBSENTSYDjHmyg0%3d 

{% endhighlight %} 


#### Sample Code (C#)

{% highlight csharp linenos %}

	// Retrieve access token    
	var accessToken = GetAccessToken(serviceAccountId, serviceAccountPassword);    
	      
	// API URL for retrieving meter data  
	var apiUrl = "https://{Panoptix Platform Services Endpoint}/";    
	      
	// Build API request. Include header with access token.  
	var request = (HttpWebRequest)WebRequest.Create(apiUrl);    
	request.Method = "GET";    
	request.Headers.Add("Authorization", "Bearer " + accessToken);    
	var response = (HttpWebResponse)request.GetResponse();    
	..... 

{% endhighlight %}

#### Sample Code (Python)

{% highlight python linenos %}

	PPSEndPoint = 'https://{Panoptix Platform Services Endpoint}'    
	opener = urllib2.build_opener(urllib2.HTTPHandler(debuglevel=1))     
	# Retrieve access token  
	token = GetAccessToken(username, password)    
	try:    
	    # Build header with access token.  
	    jsontoken = json.loads(token)    
	    header = {'Authorization': 'Bearer ' + jsontoken['access_token']}    
	    url = PPSEndPoint + "?" + urllib.urlencode( [] )    
	    req = urllib2.Request(url, None, header)   
	    
	    # API Request  
	    httpResponse = None    
	    httpResponse = opener.open(req).read()    
	    .....    
	  
	except urllib2.HTTPError, e:    
	    httpResponse = json.dumps({    
	        "statuscode":e.code,    
	        "bodymessage":e.read(),    
	        "url":url,    
	    });

{% endhighlight %}

### Token Lifetime

The access token generated is valid for 60 minutes. After this time, the token expires and a new token must be requested. If an API call is made using an expired access token, an HTTP 401 (unauthorized) error is generated.

